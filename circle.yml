machine:
  timezone:
    America/Los_Angeles

dependencies:
  pre:
    - gem install brakeman

  cache_directories:
    - /home/ubuntu/.phantomjs

database:
  override:
    - bundle exec rake db:create db:migrate          # check that migration run successfully
    - bundle exec db:migrate VERSION=20160224202923  # migrate down until irreversible migration
    - bundle exec rake db:setup                      # load from schema + seeds

test:
  override:
    - ./bin/rspect --format documentation:
        parallel: true
        files:
          - spec/**/*_spec.rb
    - brakeman --exit-on-warn

deployment:
  autodeploy:
    branch: master
    commands:
      - bin/deploy comakery-staging $CIRCLE_SHA1
