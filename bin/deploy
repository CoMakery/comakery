#!/usr/bin/env bash

# Usage: bin/deploy staging [GIT_REF]

HEROKU_ENV=$1
GIT_REF=${2:-HEAD}

if [ -z "${HEROKU_ENV}" ]; then
  echo "Usage: bin/deploy ENV [GIT_REF]"
  exit 1
fi

echo "Pushing $GIT_REF to heroku app $HEROKU_ENV..."
set -e
git push --force git@heroku.com:$HEROKU_ENV.git $GIT_REF:master
heroku config:set GIT_REF=`git rev-parse $GIT_REF` --app $HEROKU_ENV
heroku run --exit-code rake db:migrate --app comakery-$HEROKU_ENV
heroku restart --app $HEROKU_ENV || heroku restart --app $HEROKU_ENV || heroku restart --app $HEROKU_ENV
