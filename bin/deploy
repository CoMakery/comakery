#!/usr/bin/env ruby
#
# Usage: bin/deploy staging [git_ref]

require 'easy_shell'  # gives us `run`, which exits with error if commands fails

if ARGV.empty?
  STDERR.puts "Usage: bin/deploy staging|production|other [git_ref]"
  exit 1
end

heroku_env, git_ref = ARGV
git_ref ||= 'HEAD'

heroku_app="comakery-#{heroku_env}"
run "git push --force https://git.heroku.com/#{heroku_app}.git #{git_ref}:master"
run "heroku config:set git_ref=`git rev-parse #{git_ref}` --app #{heroku_app}"
run "heroku run --exit-code rake db:migrate --app #{heroku_app}"
run 5.times.map { "heroku restart --app #{heroku_app}" }.join(' || ')
