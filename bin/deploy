#!/usr/bin/env bash

# Usage: bin/deploy staging [GIT_REF]

HEROKU_ENV=$1
GIT_REF=${2:-HEAD}

if [ -z "${HEROKU_ENV}" ]; then
  echo "Usage: bin/deploy HEROKU_ENV [GIT_REF]"
  exit 1
fi

HEROKU_APP="comakery-${HEROKU_ENV}"
echo "Pushing $GIT_REF to heroku app $HEROKU_APP..."
set -e
git push --force https://git.heroku.com/$HEROKU_APP.git $GIT_REF:master
heroku config:set GIT_REF=`git rev-parse $GIT_REF` --app $HEROKU_APP
heroku run --exit-code rake db:migrate --app $HEROKU_APP
heroku restart --app $HEROKU_APP || heroku restart --app $HEROKU_APP || heroku restart --app $HEROKU_APP
